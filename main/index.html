<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Monitor da Planta</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f0f0f0; text-align: center; }
    .card {
      background: white; padding: 20px; margin: 20px auto;
      width: 95%; max-width: 800px; border-radius: 10px;
      box-shadow: 0 0 10px #aaa;
    }
    canvas { width: 100% !important; height: 350px !important; }
    .row { display: flex; justify-content: space-around; flex-wrap: wrap; margin-bottom: 15px; }
    .kpi { min-width: 150px; padding: 10px; background: #fafafa; border-radius: 8px; margin: 5px; }
    .kpi span { font-size: 1.3em; font-weight: bold; }
    .controls { margin-top: 10px; }
    input[type="number"] { width: 80px; padding: 5px; margin-right: 8px; }
    button { padding: 6px 12px; border: none; border-radius: 5px; cursor: pointer; margin: 4px; }
    button:hover { background: #e0e0ff; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Monitor da Planta</h2>

    <div class="row">
      <div class="kpi">ADC: <span id="adc">--</span></div>
      <div class="kpi">Tensão: <span id="voltage">--</span> V</div>
      <div class="kpi">Controle (Duty): <span id="duty">--</span> %</div>
    </div>

    <div class="controls">
      <label for="dutyInp">Duty (%):</label>
      <input id="dutyInp" type="number" step="0.1" min="0" max="100" value="40.0" />
      <button id="btnSet">Aplicar</button>
      <button onclick="downloadCSV()">Baixar Dados</button>
    </div>

    <canvas id="myChart"></canvas>
  </div>

  <script>
    const ctx = document.getElementById('myChart').getContext('2d');
    const chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [
          {
            label: 'Tensão (V)',
            data: [],
            borderColor: 'blue',
            fill: false,
            yAxisID: 'yV',
            tension: 0.1
          },
          {
            label: 'Sinal de Controle (Duty %)',
            data: [],
            borderColor: 'red',
            fill: false,
            yAxisID: 'yDuty',
            tension: 0.1
          }
        ]
      },
      options: {
        responsive: true,
        animation: false,
        interaction: { mode: 'index', intersect: false },
        stacked: false,
        scales: {
          yV: { type: 'linear', position: 'left', min: 0, max: 3.3, title:{display:true, text:'Tensão (V)'} },
          yDuty: { type: 'linear', position: 'right', min: 0, max: 100, title:{display:true, text:'Duty (%)'} },
          x: { title:{display:true, text:'Tempo (s)'} }
        }
      }
    });

    let t = 0; // tempo simulado em segundos
    let logData = []; // Array para armazenar dados lidos

    // Novo modo: busca lotes de dados do ESP32 e plota localmente
    async function updateBatch() {
      try {
        const r = await fetch("/data");
        const d = await r.json();

        // percorre vetor de amostras recebidas
        for (const s of d.samples) {
          const adc = Math.round(s.v * 4095 / 3.3); // estimativa do valor ADC

          chart.data.labels.push(t.toFixed(2));
          chart.data.datasets[0].data.push(s.v);
          chart.data.datasets[1].data.push(s.d);

          // salva no log para exportação posterior
          logData.push([t.toFixed(2), s.d.toFixed(1), adc, s.v.toFixed(3)]);

          t += 0.01; // 10 ms entre amostras
        }

        // mantém no máximo ~500 pontos visíveis
        if (chart.data.labels.length > 500) {
          chart.data.labels.splice(0, d.samples.length);
          chart.data.datasets[0].data.splice(0, d.samples.length);
          chart.data.datasets[1].data.splice(0, d.samples.length);
        }

        // pega o último valor das amostras e atualiza a interface
        const last = d.samples.at(-1);
        const lastAdc = Math.round(last.v * 4095 / 3.3);
        document.getElementById("adc").innerText = lastAdc;
        document.getElementById("voltage").innerText = last.v.toFixed(2);
        document.getElementById("duty").innerText = last.d.toFixed(1);

        chart.update('none');
      } catch (e) {
        console.log("Erro ao buscar /data", e);
      }
    }

    // Botão para ajustar duty em malha aberta
    document.getElementById("btnSet").addEventListener("click", async () => {
      const val = Number(document.getElementById("dutyInp").value);
      try {
        const r = await fetch(`/set?duty=${encodeURIComponent(val.toFixed(1))}`);
        const j = await r.json();
        document.getElementById("duty").innerText = j.duty.toFixed(1);
      } catch(e) {
        console.log("Erro ao ajustar duty", e);
      }
    });

    // Botão para exportar CSV
    function downloadCSV() {
      let csv = "Tempo (s),Duty (%),ADC,Tensão (V)\n";
      logData.forEach(row => {
        csv += row.join(",") + "\n";
      });
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "dados_planta.csv";
      a.click();
    }

    // Aguarda 300 ms antes de começar a atualizar (garante 3 ciclos de coleta)
    setTimeout(() => {
      setInterval(updateBatch, 100); // pede /data a cada 100 ms (10 amostras)
    }, 300);


  </script>
</body>
</html>
